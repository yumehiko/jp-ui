import{r as u}from"./iframe-DCTwtVEg.js";import{f as re}from"./floating-ui.utils.dom-CWuwp5es.js";import{u as x}from"./useStableCallback-BlvU505D.js";import{b as te}from"./mergeClassName-CGuaxy8D.js";import{c as A,m as F}from"./createBaseUIEventDetails-BDhVKG5E.js";import{B as ue,f as oe,i as ie}from"./popupStateMapping-D9WKduT9.js";import{d as G,g as ae,c as q}from"./element-C8qsRkBu.js";import{b as U}from"./event-CNRsvx7q.js";import{r as le}from"./index-zOVaSaDz.js";import{u as J}from"./useValueAsRef-BBKeM-2h.js";import{g as K}from"./safePolygon-C3u_W5Q0.js";import{u as ne}from"./useTimeout-D67vsree.js";import{T as fe}from"./constants-CNjsXAL1.js";const Z=ue("safe-polygon"),me=`button,a,[role="button"],select,[tabindex]:not([tabindex="-1"]),${fe}`;function de(r){return r?!!r.closest(me):!1}function se(r){const T=u.useRef(void 0),e=u.useRef(!1),i=u.useRef(void 0),d=u.useRef(!0),v=u.useRef(!1),M=u.useRef(()=>{}),I=u.useRef(!1),y=ne(),Y=ne(),R=u.useRef(void 0);return u.useMemo(()=>{const l=r.context.dataRef.current;return l.hoverInteractionState||(l.hoverInteractionState={pointerTypeRef:T,interactedInsideRef:e,handlerRef:i,blockMouseMoveRef:d,performedPointerEventsMutationRef:v,unbindMouseMoveRef:M,restTimeoutPendingRef:I,openChangeTimeout:y,restTimeout:Y,handleCloseOptionsRef:R}),l.hoverInteractionState},[r,T,e,i,d,v,M,I,y,Y,R])}const ge=new Set(["click","mousedown"]);function Pe(r,T={}){const e="rootStore"in r?r.rootStore:r,i=e.useState("open"),d=e.useState("floatingElement"),v=e.useState("domReferenceElement"),{dataRef:M}=e.context,{enabled:I=!0,closeDelay:y=0,externalTree:Y}=T,{pointerTypeRef:R,interactedInsideRef:l,handlerRef:_,performedPointerEventsMutationRef:P,unbindMouseMoveRef:V,restTimeoutPendingRef:g,openChangeTimeout:B,handleCloseOptionsRef:L}=se(e),b=oe(Y),j=ie(),k=x(()=>l.current?!0:M.current.openEvent?ge.has(M.current.openEvent.type):!1),h=x(()=>{const n=M.current.openEvent?.type;return n?.includes("mouse")&&n!=="mousedown"}),p=u.useCallback((n,a=!0)=>{const m=Ee(y,R.current);m&&!_.current?B.start(m,()=>e.setOpen(!1,A(F,n))):a&&(B.clear(),e.setOpen(!1,A(F,n)))},[y,_,e,R,B]),f=x(()=>{V.current(),_.current=void 0}),D=x(()=>{if(P.current){const n=G(d).body;n.style.pointerEvents="",n.removeAttribute(Z),P.current=!1}}),H=x(n=>{const a=ae(n);if(!de(a)){l.current=!1;return}l.current=!0});te(()=>{i||(R.current=void 0,g.current=!1,l.current=!1,f(),D())},[i,R,g,l,f,D]),u.useEffect(()=>()=>{f()},[f]),u.useEffect(()=>D,[D]),te(()=>{if(I&&i&&L.current?.blockPointerEvents&&h()&&re(v)&&d){P.current=!0;const n=G(d).body;n.setAttribute(Z,"");const a=v,m=d,c=b?.nodesRef.current.find(E=>E.id===j)?.context?.elements.floating;return c&&(c.style.pointerEvents=""),n.style.pointerEvents="none",a.style.pointerEvents="auto",m.style.pointerEvents="auto",()=>{n.style.pointerEvents="",a.style.pointerEvents="",m.style.pointerEvents=""}}},[I,i,v,d,L,h,b,j,P]),u.useEffect(()=>{if(!I)return;function n(E){if(k()||!M.current.floatingContext||!e.select("open"))return;const X=e.context.triggerElements;E.relatedTarget&&X.hasElement(E.relatedTarget)||(D(),f(),k()||p(E))}function a(E){B.clear(),D(),_.current?.(E),f()}function m(E){k()||p(E,!1)}const c=d;return c&&(c.addEventListener("mouseleave",n),c.addEventListener("mouseenter",a),c.addEventListener("mouseleave",m),c.addEventListener("pointerdown",H,!0)),()=>{c&&(c.removeEventListener("mouseleave",n),c.removeEventListener("mouseenter",a),c.removeEventListener("mouseleave",m),c.removeEventListener("pointerdown",H,!0))}})}function Ee(r,T){return T&&!U(T)?0:typeof r=="function"?r():r}function Q(r){return typeof r=="function"?r():r}const pe={current:null};function ke(r,T={}){const e="rootStore"in r?r.rootStore:r,{dataRef:i,events:d}=e.context,{enabled:v=!0,delay:M=0,handleClose:I=null,mouseOnly:y=!1,restMs:Y=0,move:R=!0,triggerElementRef:l=pe,externalTree:_,isActiveTrigger:P=!0}=T,V=oe(_),{pointerTypeRef:g,interactedInsideRef:B,handlerRef:L,blockMouseMoveRef:b,performedPointerEventsMutationRef:j,unbindMouseMoveRef:k,restTimeoutPendingRef:h,openChangeTimeout:p,restTimeout:f,handleCloseOptionsRef:D}=se(e),H=J(I),n=J(M),a=J(Y);P&&(D.current=H.current?.__options);const m=x(()=>B.current?!0:i.current.openEvent?["click","mousedown"].includes(i.current.openEvent.type):!1),c=u.useCallback((t,o=!0)=>{const C=K(n.current,"close",g.current);C&&!L.current?p.start(C,()=>e.setOpen(!1,A(F,t))):o&&(p.clear(),e.setOpen(!1,A(F,t)))},[n,L,e,g,p]),E=x(()=>{k.current(),L.current=void 0}),X=x(()=>{if(j.current){const t=G(e.select("domReferenceElement")).body;t.style.pointerEvents="",t.removeAttribute(Z),j.current=!1}});u.useEffect(()=>{if(!v)return;function t(o){o.open||(p.clear(),f.clear(),b.current=!0,h.current=!1)}return d.on("openchange",t),()=>{d.off("openchange",t)}},[v,d,p,f,b,h]);const ee=x(t=>{if(m()||!i.current.floatingContext)return;const o=e.context.triggerElements;if(t.relatedTarget&&o.hasElement(t.relatedTarget))return;const C=l.current;H.current?.({...i.current.floatingContext,tree:V,x:t.clientX,y:t.clientY,onClose(){X(),E(),!m()&&C===e.select("domReferenceElement")&&c(t)}})(t)});return u.useEffect(()=>{if(!v)return;const t=l.current??(P?e.select("domReferenceElement"):null);if(!re(t))return;function o(s){if(p.clear(),b.current=!1,y&&!U(g.current)||Q(a.current)>0&&!K(n.current,"open"))return;const w=K(n.current,"open",g.current),O=e.select("domReferenceElement"),S=e.context.triggerElements,N=(S.hasElement(s.target)||S.hasMatchingElement(ce=>q(ce,s.target)))&&(!O||!q(O,s.target)),W=s.currentTarget??null,$=!e.select("open")||N;w?p.start(w,()=>{$&&e.setOpen(!0,A(F,s,W))}):$&&e.setOpen(!0,A(F,s,W))}function C(s){if(m()){X();return}k.current();const w=e.select("domReferenceElement"),O=G(w);f.clear(),h.current=!1;const S=e.context.triggerElements;if(s.relatedTarget&&S.hasElement(s.relatedTarget))return;if(H.current&&i.current.floatingContext){e.select("open")||p.clear();const W=l.current;L.current=H.current({...i.current.floatingContext,tree:V,x:s.clientX,y:s.clientY,onClose(){X(),E(),!m()&&W===e.select("domReferenceElement")&&c(s,!0)}});const $=L.current;$(s),O.addEventListener("mousemove",$),k.current=()=>{O.removeEventListener("mousemove",$)};return}(g.current!=="touch"||!q(e.select("floatingElement"),s.relatedTarget))&&c(s)}function z(s){ee(s)}return e.select("open")&&t.addEventListener("mouseleave",z),R&&t.addEventListener("mousemove",o,{once:!0}),t.addEventListener("mouseenter",o),t.addEventListener("mouseleave",C),()=>{t.removeEventListener("mouseleave",z),R&&t.removeEventListener("mousemove",o),t.removeEventListener("mouseenter",o),t.removeEventListener("mouseleave",C)}},[E,X,b,i,n,c,e,v,H,ee,P,m,y,R,g,a,f,h,p,l,V,k,L]),u.useMemo(()=>{function t(o){g.current=o.pointerType}return{onPointerDown:t,onPointerEnter:t,onMouseMove(o){const{nativeEvent:C}=o,z=o.currentTarget,s=e.select("domReferenceElement"),w=e.context.triggerElements,O=e.select("open"),S=(w.hasElement(o.target)||w.hasMatchingElement(W=>q(W,o.target)))&&(!s||!q(s,o.target));if(y&&!U(g.current)||O&&!S||Q(a.current)===0||!S&&h.current&&o.movementX**2+o.movementY**2<2)return;f.clear();function N(){!b.current&&(!O||S)&&e.setOpen(!0,A(F,C,z))}g.current==="touch"?le.flushSync(()=>{N()}):S&&O?N():(h.current=!0,f.start(Q(a.current),N))}}},[b,y,e,g,a,f,h])}export{Pe as a,ke as u};
